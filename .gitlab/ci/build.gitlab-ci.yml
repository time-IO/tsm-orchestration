---

build-and-push-images:
  stage: build
  image: "docker:${DOCKER_IMAGE_TAG}"
  before_script:
    - mkdir images -p
    - cp .env.example .env
    - echo $(date +%Y-%m-%d-%H%M%S) > .build_date
    - |
      echo "TIMEIO_INIT_IMAGE_TAG=$CI_COMMIT_REF_NAME" >> .env
      echo "TIMEIO_DATABASE_IMAGE_TAG=$CI_COMMIT_REF_NAME" >> .env
      echo "TIMEIO_FROST_IMAGE_TAG=$CI_COMMIT_REF_NAME" >> .env
      echo "TIMEIO_CRON_SCHEDULER_IMAGE_TAG=$CI_COMMIT_REF_NAME" >> .env
      echo "TIMEIO_DISPATCHER_IMAGE_TAG=$CI_COMMIT_REF_NAME" >> .env
      echo "TIMEIO_CONFIGDB_UPDATER_IMAGE_TAG=$CI_COMMIT_REF_NAME" >> .env
    - export REGISTRY=$(grep TIMEIO_IMAGE_REGISTRY .env | cut -d'=' -f2)
    - echo $CI_REGISTRY_PASSWORD | docker login $REGISTRY -u $CI_REGISTRY_USER --password-stdin
  after_script:
    - docker logout
  script:
    - docker compose build -q --push init cron-scheduler frost worker-configdb-updater worker-db-setup
    # docker images -a
    #- docker save -o images/init.tar ${REGISTRY}/init:$CI_COMMIT_REF_NAME
    #- docker save -o images/cron-scheduler.tar ${REGISTRY}/cron-scheduler:$CI_COMMIT_REF_NAME
    #- docker save -o images/frost.tar ${REGISTRY}/frost:$CI_COMMIT_REF_NAME
    #- docker save -o images/worker-configdb-updater.tar ${REGISTRY}/worker-configdb-updater:$CI_COMMIT_REF_NAME
    #- docker save -o images/worker-db-setup.tar ${REGISTRY}/worker-db-setup:$CI_COMMIT_REF_NAME
    #- ls images/*.tar
  tags:
    - "dind"
  artifacts:
    paths:
      - .env

build-images:
  stage: build
  image: "docker:${DOCKER_IMAGE_TAG}"
  before_script:
    - mkdir images -p
    - cp .env.example .env
    - echo $(date +%Y-%m-%d-%H%M%S) > .build_date
    - |
      echo "TIMEIO_INIT_IMAGE_TAG=$CI_COMMIT_REF_NAME" >> .env
      echo "TIMEIO_DATABASE_IMAGE_TAG=$CI_COMMIT_REF_NAME" >> .env
      echo "TIMEIO_FROST_IMAGE_TAG=$CI_COMMIT_REF_NAME" >> .env
      echo "TIMEIO_CRON_SCHEDULER_IMAGE_TAG=$CI_COMMIT_REF_NAME" >> .env
      echo "TIMEIO_DISPATCHER_IMAGE_TAG=$CI_COMMIT_REF_NAME" >> .env
      echo "TIMEIO_CONFIGDB_UPDATER_IMAGE_TAG=$CI_COMMIT_REF_NAME" >> .env
    - export REGISTRY=$(grep TIMEIO_IMAGE_REGISTRY .env | cut -d'=' -f2)
  script:
    - docker compose build -q init frost cron-scheduler cron-scheduler frost worker-configdb-updater worker-db-setup
    - docker images -a
    - docker save -o images/init.tar ${REGISTRY}/init:$CI_COMMIT_REF_NAME
    - docker save -o images/cron-scheduler.tar ${REGISTRY}/cron-scheduler:$CI_COMMIT_REF_NAME
    - docker save -o images/frost.tar ${REGISTRY}/frost:$CI_COMMIT_REF_NAME
    - docker save -o images/worker-configdb-updater.tar ${REGISTRY}/worker-configdb-updater:$CI_COMMIT_REF_NAME
    - docker save -o images/worker-db-setup.tar ${REGISTRY}/worker-db-setup:$CI_COMMIT_REF_NAME
    - ls images/*.tar
  artifacts:
    paths:
      - images
      - .build_date
      - .env
    expire_in: 15 minutes
  tags:
    - "dind"

load-images:
  dependencies:
    - build-images
  stage: load
  image: "docker:${DOCKER_IMAGE_TAG}"
  script:
    - for image in $(ls images/*.tar); do docker load < $image; done
    - docker images -a
    - docker compose up -d --quiet-pull
    - docker compose ps
  tags:
    - "dind"

load-images-from-registry:
  dependencies:
    - build-and-push-images
  stage: load
  image: "docker:${DOCKER_IMAGE_TAG}"
  before_script:
  script:
    - docker compose pull -q
    - docker images -a
    - docker compose up -d
    - docker compose ps
  tags:
    - "dind"