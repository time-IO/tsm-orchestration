---

deploy-images-to-registry:
  stage: release
  rules:
    # Rules are evaluated in order until the first match.
    # We only want to push new images if source files changes
    # or if we manually decide to do so.
    - if: "$CI_COMMIT_BRANCH == 'main' && $CI_PIPELINE_SOURCE != 'merge_request_event'"
      changes:
        - .env.example
        - src/**/*
        - dispatcher/**/*
        - configdb_updater/**/*
        - init/**/*
        - tomcat/**/*
    - if: "$CI_COMMIT_BRANCH == 'main' && $CI_PIPELINE_SOURCE != 'merge_request_event'"
      when: manual
  image: "docker:${DOCKER_IMAGE_TAG}"
  needs: []
  before_script:
    - cp .env.example .env
    # return both parent commits
    - export PARENT_SHA_1=$(git log --pretty=%P -n 1 $CI_COMMIT_SHA | awk '{print $1}')
    - export PARENT_SHA_2=$(git log --pretty=%P -n 1 $CI_COMMIT_SHA | awk '{print $2}')
    # return parent commit branch names
    - export PARENT_BRANCH_1=$(git branch --contains $PARENT_SHA_1 --format="%(refname:short)" | head -n 1)
    - export PARENT_BRANCH_2=$(git branch --contains $PARENT_SHA_2 --format="%(refname:short)" | head -n 1)
    # set BRANCH_NAME to PARENT_BRANCH that is not "main"
    - |
      if [[ "$PARENT_BRANCH_1" != "main" ]]; then
        export BRANCH_NAME=$PARENT_BRANCH_1
      elif [[ "$PARENT_BRANCH_2" != "main" ]]; then
        export BRANCH_NAME=$PARENT_BRANCH_2
      else
        echo "Both parent branches are 'main', can not determine non-main parent branch"
        exit 1
      fi
    - |
      echo "TIMEIO_INIT_IMAGE_TAG=$BRANCH_NAME" >> .env
      echo "TIMEIO_FROST_IMAGE_TAG=$BRANCH_NAME" >> .env
      echo "TIMEIO_CRON_SCHEDULER_IMAGE_TAG=$BRANCH_NAME" >> .env
      echo "TIMEIO_DISPATCHER_IMAGE_TAG=$BRANCH_NAME" >> .env
      echo "TIMEIO_CONFIGDB_UPDATER_IMAGE_TAG=$BRANCH_NAME" >> .env
    - export BUILD_DATE=$(echo -n $(date -u +%Y-%m-%d-%H%M%S))
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
    - export REGISTRY=$(grep TIMEIO_IMAGE_REGISTRY .env | cut -d'=' -f2)
    - echo "pulling images from branch $BRANCH_NAME"
  after_script:
    - docker logout
  script:
    - docker compose pull -q init frost cron-scheduler worker-configdb-updater worker-db-setup
    - |
      for image in $(docker images --format '{{ .Repository }}'); do 
        docker tag $image:$BRANCH_NAME $image:latest;
        docker tag $image:$BRANCH_NAME $image:$BUILD_DATE;
        docker push $image:latest;
        docker push $image:$BUILD_DATE;
      done
  tags:
    - "dind"
